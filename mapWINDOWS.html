<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Umbe MapViewer</title>
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://openlayers.org/en/v4.6.5/css/ol.css" type="text/css">
    <link rel="stylesheet" href="./ol/css/ol-umbe_3.css" type="text/css">
    <link rel="stylesheet" href="./ol/sidebar-v2-master/css/ol3-sidebar.css" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <!-- Because Bootstrap is not compatible with jquery > 3 -->
    <!-- <script src="../js/jquery-3.2.1.min.js"></script> -->
    <script src="https://code.jquery.com/jquery-2.2.3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.4.4/proj4.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
    <!-- The line below is only needed for old environments like Internet Explorer and Android 4.x -->
    <script src="https://cdn.polyfill.io/v2/polyfill.min.js?features=requestAnimationFrame,Element.prototype.classList,URL"></script>
    <script src="https://openlayers.org/en/v4.6.5/build/ol.js" type="text/javascript"></script>
    <script src="./ol/sidebar-v2-master/js/ol3-sidebar.js"></script>
</head>

<body>
    <div style="display: none;">
        <!-- Popup -->
        <div id="popup" title="POPUP UMBE"></div>
    </div>
    <div id="sidebar" class="sidebar collapsed">
        <!-- Nav tabs -->
        <div class="sidebar-tabs">
            <ul role="tablist">
                <li><a href="#layers" role="tab"><i class="fa fa-bars"></i></a></li>
                <li><a href="#basemap" role="tab"><i class="fa fa-map-o"></i></a></li>
                <li><a href="#query" role="tab"><i class="fa fa-filter"></i></a></li>
                <li><a href="#position" role="tab"><i class="fa fa-map-marker"></i></a></li>
                <li class="disabled"><a href="#messages" role="tab"><i class="fa fa-envelope"></i></a></li>
            </ul>
            <ul role="tablist">
                <li><a href="#settings" role="tab"><i class="fa fa-gear"></i></a></li>
            </ul>
        </div>
        <!-- Tab panes -->
        <div class="sidebar-content">
            <div class="sidebar-pane" id="layers">
                <h1 class="sidebar-header">Layers<span class="sidebar-close"><i class="fa fa-caret-left"></i></span></h1>
                <div class="checkbox">
                    <label><input type="checkbox" id="layer1">Layer 1</label><span id='zoom_to'><i class="fa fa-search"></i></span>
                    <br>
                    <label><input type="checkbox" id="layer2">Layer 2</label><span id='zoom_to'><i class="fa fa-search"></i></span>
                </div>
            </div>
            <div class="sidebar-pane" id="basemap">
                <h1 class="sidebar-header">Basemap<span class="sidebar-close"><i class="fa fa-caret-left"></i></span></h1>
                <div class="radio">
                    <label><input type="radio" name="optradio" id="basemap1" checked>OSM</label>
                    <br>
                    <label><input type="radio" name="optradio" id="basemap2">ESRI World Imagery</label>
                    <br>
                    <label><input type="radio" name="optradio" id="basemap3">TileMill</label>
                </div>
            </div>
            <div class="sidebar-pane" id="query">
                <h1 class="sidebar-header">Query<span class="sidebar-close"><i class="fa fa-caret-left"></i></span></h1>
                <select class="query">
                  <option value="%" selected>All layers</option>
                  <option value="Trebbiano di Soave">Trebbiano di Soave</option>
                  <option value="Tocai friulano">Tocai friulano</option>
                  <option value="Sangiovese, Marzemino, Barbera, Merlot, Incrocio T">Sangiovese, Marzemino, Barbera, Merlot, Incrocio T</option>
                  <option value="Riesling Renano, Incrocio Manzoni, Muller Thurgau">Riesling Renano, Incrocio Manzoni, Muller Thurgau</option>
                  <option value="Marzemino, Barbera, Schiava gentile, Cabernet">Marzemino, Barbera, Schiava gentile, Cabernet</option>
                  <option value="Groppello">Groppello</option>
               </select>
            </div>
            <div class="sidebar-pane" id="position">
                <h1 class="sidebar-header">
                    sidebar-v2
                    <span class="sidebar-close"><i class="fa fa-caret-left"></i></span>
                </h1>
                <label for="track">
               track position
               <input id="track" type="checkbox"/>
               </label>
                <p id="info" style="display: none;"></p>
            </div>
            <div class="sidebar-pane" id="messages">
                <h1 class="sidebar-header">Messages<span class="sidebar-close"><i class="fa fa-caret-left"></i></span></h1>
            </div>
            <div class="sidebar-pane" id="settings">
                <h1 class="sidebar-header">Settings<span class="sidebar-close"><i class="fa fa-caret-left"></i></span></h1>
            </div>
        </div>
    </div>
    <div id="map" class="sidebar-map"></div>
    <script>
        // PROJECTION

        proj4.defs('EPSG:3857', '+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +wktext  +no_defs');

        // IMAGE EXTENT

        var imageExtent = [952014.59, 5571269.68, 1272301.10, 5862273.22];

        // WMS PARSER (https://bl.ocks.org/ThomasG77/5f9e62d3adeb5602d230a6eacbb9c443)

        var base_url = 'https://localhost/cgi-bin/mapserver/mapserv.exe?map=C:\\DATI\\git\\shire\\\mapfile\\\mapfile\\mymapWINDOWS.map&'
        var parser = new ol.format.WMSCapabilities();

        // Parse WMS Capabilities to retrieve layer extent
        fetch(base_url + 'SERVICE=WMS&VERSION=1.3.0&REQUEST=GetCapabilities').then(function(response) {
                return response.text();
            }).then(function(text) {
                    var result = parser.read(text);
                    var extent = result.Capability.Layer.Layer.find(l => l.Name === 'zone').EX_GeographicBoundingBox;
                    var extent_3857 = ol.proj.transformExtent(extent, 'EPSG:4326', 'EPSG:3857')

                    // SOURCES

                    // Mapserver WMS
                    var wmsSource1 = new ol.source.ImageWMS({
                        url: base_url,
                        params: {
                            'LAYERS': 'cantine',
                            'CRS': 'EPSG:3857',
                            'FORMAT': 'image/png'
                        },
                        projection: 'EPSG:3857',
                        serverType: 'mapserver',
                    });

                    // Mapserver WMS
                    var wmsSource2 = new ol.source.ImageWMS({
                        url: base_url,
                        params: {
                            'LAYERS': 'zone',
                            'vitigni': '%',
                            'CRS': 'EPSG:3857',
                            'FORMAT': 'image/png'
                        },
                        projection: 'EPSG:3857',
                        serverType: 'mapserver',
                    });

                    var osmBasemap = new ol.source.OSM();

                    var esriBasemap = new ol.source.XYZ({
                        url: 'http://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
                        attributions: 'Tiles © Esri — Esri, DeLorme, NAVTEQ, TomTom, Intermap, iPC, USGS, FAO, NPS, NRCAN, GeoBase, Kadaster NL, Ordnance Survey, Esri Japan, METI, Esri China (Hong Kong), and the GIS User Community',
                    });

                    // LAYER EXTENT (https://bl.ocks.org/ThomasG77/5f9e62d3adeb5602d230a6eacbb9c443)
                    var parser = new ol.format.WMSCapabilities();

                    // Parse WMS Capabilities to retrieve layer extent
                    fetch(base_url.concat('SERVICE=WMS&VERSION=1.3.0&REQUEST=GetCapabilities')).then(function(response) {
                        return response.text();
                    }).then(function(text) {
                        var result = parser.read(text);
                        var extent = result.Capability.Layer.Layer.find(l => l.Name === 'zone').EX_GeographicBoundingBox;
                        // CONTINUA

                        // LAYERS

                        var layer1 = new ol.layer.Image({
                            title: 'cantine',
                            visible: false,
                            source: wmsSource1,
                        });

                        var layer2 = new ol.layer.Image({
                            title: 'zone',
                            visible: false,
                            source: wmsSource2,
                            extent: extent_3857
                        });

                        var basemap1 = new ol.layer.Tile({
                            title: 'OSM',
                            type: 'base',
                            visible: true,
                            source: osmBasemap
                        });

                        var basemap2 = new ol.layer.Tile({
                            title: 'ESRI_WorldImagery',
                            type: 'base',
                            visible: false,
                            source: esriBasemap
                        });


                        // LAYER GROUPS

                        var overlays_group = new ol.layer.Group({
                            title: 'Overlays',
                            layers: [
                                layer1,
                                layer2,
                            ]
                        });

                        var basemap_group = new ol.layer.Group({
                            title: 'Basemaps',
                            layers: [
                                basemap1,
                                basemap2,
                            ]
                        });

                        // define array of layer groups

                        var layer_groups = [
                            basemap_group,
                            overlays_group,
                        ]

                        // VIEW

                        var view = new ol.View({
                            center: ol.extent.getCenter(imageExtent),
                            zoom: 8
                        });

                        // MAP

                        var map = new ol.Map({
                            layers: layer_groups,
                            target: 'map',
                            view: view
                        });

                        // GEOLOCATION (https://openlayers.org/en/latest/examples/geolocation.html)

                        var geolocation = new ol.Geolocation({
                            projection: view.getProjection()
                        });

                        function el(id) {
                            return document.getElementById(id);
                        }

                        el('track').addEventListener('change', function() {
                            geolocation.setTracking(this.checked);
                        });

                        // handle geolocation error

                        geolocation.on('error', function(error) {
                            var info = document.getElementById('info');
                            info.innerHTML = error.message;
                            info.style.display = '';
                        });

                        // render position feature

                        var positionFeature = new ol.Feature();
                        positionFeature.setStyle(new ol.style.Style({
                            image: new ol.style.Circle({
                                radius: 6,
                                fill: new ol.style.Fill({
                                    color: '#3399CC'
                                }),
                                stroke: new ol.style.Stroke({
                                    color: '#fff',
                                    width: 2
                                })
                            })
                        }));

                        geolocation.on('change:position', function() {
                            var coordinates = geolocation.getPosition();
                            positionFeature.setGeometry(coordinates ?
                                new ol.geom.Point(coordinates) : null);
                        });

                        // add position feature to map

                        new ol.layer.Vector({
                            map: map,
                            source: new ol.source.Vector({
                                features: [positionFeature]
                            })
                        });

                        // POPUP

                        var popup = new ol.Overlay({
                            element: document.getElementById('popup')
                        });
                        map.addOverlay(popup);

                        // Add a click handler to the map to render the popup.

                        map.on('singleclick', function(evt) {
                            var element = popup.getElement();
                            var coordinate = evt.coordinate;
                            var viewResolution = /** @type {number} */ (view.getResolution());
                            var url = '';
                            var root = map.getLayerGroup();
                            var groups = root.getLayers();
                            groups.forEach(function(group) {
                                layers = group.getLayers();
                                layers.forEach(function(layer) {
                                    if (layer.get('type') != 'base') {
                                        var visible = layer.getVisible();
                                        if (visible) {
                                            url += layer.get('source').getGetFeatureInfoUrl(evt.coordinate, viewResolution, 'EPSG:3857', {
                                                'INFO_FORMAT': 'text/html'
                                            });
                                            $.get(url, function(data) {
                                                if (data.length != 0) {
                                                    $(element).popover('destroy');
                                                    popup.setPosition(coordinate);
                                                    $(element).popover({
                                                        'placement': 'top',
                                                        'animation': false,
                                                        'html': true,
                                                        'content': data
                                                    });
                                                    $(element).popover('show');
                                                } else {
                                                    popup.setPosition(undefined);
                                                }
                                            })
                                        }
                                    }
                                })
                            })
                        });

                        // SIDEBAR

                        var sidebar = new ol.control.Sidebar({
                            element: 'sidebar',
                            position: 'left'
                        });

                        // add sidebar to map

                        map.addControl(sidebar);

                        // LAYER VISIBILITY

                        $('input[type=checkbox]').on('change', function() {
                            var layer = {
                                layer1: layer1,
                                layer2: layer2,
                            }[$(this).attr('id')];
                            layer.setVisible(!layer.getVisible());
                        });

                        // BASEMAP RADIO BUTTONS
                        $('input[type=radio]').on('change', function() {
                            var basemaps = {
                                basemap1: basemap1,
                                basemap2: basemap2,
                            };

                            // turn off all basemaps...
                            for (i in basemaps) {
                                basemaps[i].setVisible(false);
                            }

                            // then turn on only clicked basemap
                            basemaps[$(this).attr('id')].setVisible(true);
                        });

                        // DEFINITION QUERY (GEOMETRIC FILTERS)
                        // update WMS parameters (filter, see mapfile) based on user selected choice
                        $('.query').on('change', function() {
                            var filter = $(this).val();
                            var params = wmsSource2.getParams();
                            params.vitigni = filter;
                            wmsSource2.updateParams(params);
                        });

                        // ZOOM
                        // in the layers tab, zoom map to layer when zoom icon is clicked
                        $('.fa-search').on('click', function() {
                            var layer = layer2;
                            view.fit(layer.getExtent(), {
                                duration: 1000
                            });
                        });
                    });
    </script>
</body>

</html>
