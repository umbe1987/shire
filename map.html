<!DOCTYPE html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Umbe MapViewer</title>
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://openlayers.org/en/v5.0.0/css/ol.css" type="text/css">
    <link rel="stylesheet" href="./ol/sidebar-v2/css/ol3-sidebar.css" />
    <link rel="stylesheet" href="./ol/ol-layerswitcher/src/ol-layerswitcher.css" />
    <link rel="stylesheet" href="./ol/css/ol-umbe.css" type="text/css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    
    <!-- Because Bootstrap is not compatible with jquery > 3 -->

    <!-- <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha256-3edrmyuQ0w65f8gfBsqowzjJe2iM6n0nKciPUp8y+7E=" crossorigin="anonymous"></script> -->
    <script src="https://code.jquery.com/jquery-2.2.3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.4.4/proj4.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
    <!-- The line below is only needed for old environments like Internet Explorer and Android 4.x -->
    <script src="https://cdn.polyfill.io/v2/polyfill.min.js?features=requestAnimationFrame,Element.prototype.classList,URL"></script>
    <script src="https://openlayers.org/en/v5.0.0/build/ol.js" type="text/javascript"></script>
    <script src="./ol/sidebar-v2/js/ol3-sidebar.js"></script>
    <script src="./ol/ol-layerswitcher/dist/ol-layerswitcher.js"></script>
</head>

<body>
    <!-- The Modal -->
    <div id="alertModal" class="modal">

        <!-- Modal content -->
        <div class="modal-content">
            <div class="modal-header">
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
            </div>
        </div>
    </div>

    <div style="display: none;">
        <!-- Popup -->
        <div id="popup" title="POPUP UMBE"></div>
    </div>
    <div id="sidebar" class="sidebar collapsed">
        <!-- Nav tabs -->
        <div class="sidebar-tabs">
            <ul role="tablist">
                <li><a href="#toc" role="tab"><i class="fa fa-bars"></i></a></li>
                <li><a href="#basemap" role="tab"><i class="fa fa-map-o"></i></a></li>
                <li class="disabled"><a href="#info" role="tab"><i class="fa fa-info" aria-hidden="true"></i></a></li>
                <li><a href="#query" role="tab"><i class="fa fa-filter"></i></a></li>
                <li><a href="#position" role="tab"><i class="fa fa-map-marker"></i></a></li>
            </ul>
            <ul role="tablist">
                <li><a href="#settings" role="tab"><i class="fa fa-gear"></i></a></li>
            </ul>
        </div>
        <!-- Tab panes -->
        <div class="sidebar-content">
            <div class="sidebar-pane" id="toc">
                <div>
                    <h1 class="sidebar-header">Layers<span class="sidebar-close"><i class="fa fa-caret-left"></i></span></h1>
                </div>
                <!-- !!! HERE WILL GO THE CONTENT OF LAYERSWITCHER !!! -->
                <div id="layers" class="sidebar-content layer-switcher" style="top: 40px;left: 0px;overflow:auto;"></div>
            </div>
            <div class="sidebar-pane" id="basemap">
                <h1 class="sidebar-header">Basemap<span class="sidebar-close"><i class="fa fa-caret-left"></i></span></h1>
                <div class="radio">
                    <label><input type="radio" name="optradio" id="basemap1" checked>OSM</label>
                    <br>
                    <label><input type="radio" name="optradio" id="basemap2">ESRI World Imagery</label>
                    <br>
                    <label><input type="radio" name="optradio" id="basemap3">TileMill</label>
                </div>
            </div>
            <div class="sidebar-pane" id="info">
                <h1 class="sidebar-header">Info<span class="sidebar-close"><i class="fa fa-caret-left"></i></span></h1>
            </div>
            <div class="sidebar-pane" id="query">
                <h1 class="sidebar-header">Query<span class="sidebar-close"><i class="fa fa-caret-left"></i></span></h1>
                <select class="query">
                  <option value="%" selected>All layers</option>
                  <option value="Trebbiano di Soave">Trebbiano di Soave</option>
                  <option value="Tocai friulano">Tocai friulano</option>
                  <option value="Sangiovese, Marzemino, Barbera, Merlot, Incrocio T">Sangiovese, Marzemino, Barbera, Merlot, Incrocio T</option>
                  <option value="Riesling Renano, Incrocio Manzoni, Muller Thurgau">Riesling Renano, Incrocio Manzoni, Muller Thurgau</option>
                  <option value="Marzemino, Barbera, Schiava gentile, Cabernet">Marzemino, Barbera, Schiava gentile, Cabernet</option>
                  <option value="Groppello">Groppello</option>
               </select>
            </div>
            <div class="sidebar-pane" id="position">
                <h1 class="sidebar-header">
                    Geolocation
                    <span class="sidebar-close"><i class="fa fa-caret-left"></i></span>
                </h1>
                <label for="track">
               track position
               <input id="track" type="checkbox"/>
               </label>
                <p id="location_err" style="display: none;"></p>
            </div>
            <div class="sidebar-pane" id="settings">
                <h1 class="sidebar-header">Settings<span class="sidebar-close"><i class="fa fa-caret-left"></i></span></h1>
                <div class="checkbox">
                    <label><input type="checkbox" id="info_settings">Display layer info in panel instead of popups</label>
                </div>
            </div>
        </div>
    </div>
    <div id="map" class="sidebar-map"></div>
    <script>
        // global declarations
        var cors_prefix = 'https://cors-anywhere.herokuapp.com/';
        
        // fancy alert for errors
        function fancyAlert(errorType, text) {
                // Get modal-header element
                var modalHeader = document.getElementsByClassName("modal-header");
                // check if modal-header has been previously set (remove H2 if so)
                var hOld = modalHeader[0].children[1]; // .children[1] is H2 node ('undefined' if not exists)
                if (document.contains(hOld)) {
                    modalHeader[0].removeChild(hOld);
                }
                // Set modal-header content
                var hNew = document.createElement("H2");
                var t = document.createTextNode(errorType);
                hNew.appendChild(t);
                document.getElementsByClassName("modal-header")[0].appendChild(hNew);

                // Set modal-body content
                document.getElementsByClassName("modal-body")[0].innerHTML = text;

                // Get the modal
                var modal = document.getElementById('alertModal');
                // Get the <span> element that closes the modal
                var span = document.getElementsByClassName("close")[0];
                modal.style.display = "block";
                // When the user clicks on <span> (x), close the modal
                span.onclick = function() {
                    modal.style.display = "none";
                }
                // When the user clicks anywhere outside of the modal, close it
                window.onclick = function(event) {
                if (event.target == modal) {
                    modal.style.display = "none";
                }
            }
        };


        // function to let OL handle WMS exceptions (https://stackoverflow.com/a/29790150/1979665)
        function imageLoadFunction (image, src) {
            var img = image.getImage();
            if (typeof window.btoa == 'function') {
                var xhr = new XMLHttpRequest();
                xhr.open('GET', cors_prefix + src, true);
                xhr.setRequestHeader("Access-Control-Allow-Headers", "origin,x-requested-with");
                xhr.responseType = 'arraybuffer';
                xhr.onload = function(e) {
                   if (this.status == 200) {
                       var uInt8Array = new Uint8Array(this.response);
                       var i = uInt8Array.length;
                       var binaryString = new Array(i);
                       while (i--) {
                           binaryString[i] = String.fromCharCode(uInt8Array[i]);
                       }
                       var data = binaryString.join('');
                       var type = xhr.getResponseHeader('content-type');
                       if (type.indexOf('image') === 0) {
                           img.src = 'data:' + type + ';base64,' + window.btoa(data);
                       } else { // HANDLE WMS EXCEPTIONS
                           var exceptionAsText = String.fromCharCode.apply(null, uInt8Array);
                           // as console.error
                           console.error(exceptionAsText);
                           // as fancy alerts
                           fancyAlert('WMS Exception', exceptionAsText);
                       }
                   } else {
                       alert(error(this.statusText));
                   }
                };
                xhr.send();
            } else {
               img.onerror = function() {
                    alert(error());
                };
                img.src = src;
            }
        };

        // WMS PARSER (https://bl.ocks.org/ThomasG77/5f9e62d3adeb5602d230a6eacbb9c443)


        // async call to get a parseable txt response from a WMS url (using 'ol.format.WMSCapabilities()')
        // (async function always return a Promise)
        async function getWMSResponse(url){
            try {
                var parser = new ol.format.WMSCapabilities();
                // fetch return a Promise
                var getCapabilities_suffix = 'SERVICE=WMS&REQUEST=GetCapabilities';
                var compositeRequest = cors_prefix + url + getCapabilities_suffix;
                // remove white spaces
                var response = await fetch(compositeRequest.replace(" ", ""));
                var text = await response.text();

                return parser.read(text);
            } catch(e) {
                console.log(e);
                return null;
            }
        }

        // Get layers objects from a WMS parser
        // (async function always return a Promise)
        async function getWMSLayers(url){
            try {
                var wms_parser = await getWMSResponse(url);
                var layers = wms_parser.Capability.Layer;

                return [layers];
            } catch(e) {
                console.log(e);
                return null;
            }
        }

        // get layers and grouprlayers from getWMSLayers
        function getLayers(layers, url) {
            // if there is at least one layer
            if (layers) {
                let wms_layers = [];
                for (let i = 0; i < layers.length; i++) {
                    let lyr = layers[i];
                    // name of ith layer
                    let layer_name = layers[i].Name;
                    // title of ith layer
                    let layer_title = layers[i].Title;
                    // check if this is a group layer
                    if (lyr.Layer) {
                        let sublayers = getLayers(lyr.Layer, url);
                        let ith_group = new ol.layer.Group({
                            title: layer_title,
                            layers: sublayers,
                        });
                        wms_layers.push(ith_group);
                    } else {
                        let source = new ol.source.ImageWMS({
                            url: wms_url,
                            params: {
                                'LAYERS': layer_name, // 'FAKE' (to test exceptions)
                                'FORMAT': 'image/png',
                            },
                        });
                            // log message in case of error event
                            source.on('imageloaderror', function(event) {
                                console.log('imageloaderror event fired');
                            });
                            source.setImageLoadFunction(imageLoadFunction);
                        let ith_lyr = new ol.layer.Image({
                            title: layer_title,
                            visible: false,
                            source: source,
                        });
                        wms_layers.push(ith_lyr);
                    }
                }
                return wms_layers;
            } else {
                return
            }
        }

        // PROJECTION

        proj4.defs('EPSG:3857', '+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +wktext  +no_defs');

        // IMAGE EXTENT

        var imageExtent = [952014.59, 5571269.68, 1272301.10, 5862273.22];
        var wms_url = 'https://servizigis.regione.emilia-romagna.it/wms/rete_escursionistica?';
        // var wms_crs = 'EPSG:3857';

        // Parse WMS Capabilities to retrieve layers and build the map
        getWMSLayers(wms_url).then(layers => {

            // OPERATIONAL LAYERS
            var wms_layers = getLayers(layers, wms_url);
            
            // BASEMAP LAYERS

            // OSM Basemap
            var osmBasemap = new ol.source.OSM();

            // Esri Basemap
            var esriBasemap = new ol.source.XYZ({
                url: 'http://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
                attributions: 'Tiles © Esri — Esri, DeLorme, NAVTEQ, TomTom, Intermap, iPC, USGS, FAO, NPS, NRCAN, GeoBase, Kadaster NL, Ordnance Survey, Esri Japan, METI, Esri China (Hong Kong), and the GIS User Community',
            });


            var basemap1 = new ol.layer.Tile({
                title: 'OSM',
                type: 'base',
                visible: true,
                source: osmBasemap
            });

            var basemap2 = new ol.layer.Tile({
                title: 'ESRI_WorldImagery',
                type: 'base',
                visible: false,
                source: esriBasemap
            });

            // LAYER GROUPS
            // for OPERATIONAL

            var overlays_group = new ol.layer.Group({
                title: 'Overlays',
                layers: wms_layers,
            });

            // for BASEMAP
            var basemap_group = new ol.layer.Group({
                title: 'Basemaps',
                layers: [
                    basemap1,
                    basemap2,
                ]
            });

            // define array of layer groups

            var layer_groups = [
                basemap_group,
                overlays_group,
            ]

            // VIEW

            var view = new ol.View({
                center: ol.extent.getCenter(imageExtent),
                zoom: 8
            });

            // MAP

            var map = new ol.Map({
                layers: layer_groups,
                target: 'map',
                view: view
            });

            // GEOLOCATION (https://openlayers.org/en/latest/examples/geolocation.html)

            var geolocation = new ol.Geolocation({
                projection: view.getProjection()
            });

            function el(id) {
                return document.getElementById(id);
            }

            el('track').addEventListener('change', function() {
                geolocation.setTracking(this.checked);
            });

            // handle geolocation error

            geolocation.on('error', function(error) {
                var location_err = document.getElementById('location_err');
                location_err.innerHTML = error.message;
                location_err.style.display = '';
            });

            // render position feature

            var positionFeature = new ol.Feature();
            positionFeature.setStyle(new ol.style.Style({
                image: new ol.style.Circle({
                    radius: 6,
                    fill: new ol.style.Fill({
                        color: '#3399CC'
                    }),
                    stroke: new ol.style.Stroke({
                        color: '#fff',
                        width: 2
                    })
                })
            }));

            geolocation.on('change:position', function() {
                var coordinates = geolocation.getPosition();
                positionFeature.setGeometry(coordinates ?
                    new ol.geom.Point(coordinates) : null);
            });

            // add position feature to map

            new ol.layer.Vector({
                map: map,
                source: new ol.source.Vector({
                    features: [positionFeature]
                })
            });

            // CHECK IF LAYER INFO SHOULD DISPLAY IN POPUP OR PANEL
            
            // check if info layer panel is off (as default)
            var info_tab = $("a[href$='#info']").first().parent();
            var info_class = info_tab.attr('class');
            var info_popup = true;
            info_panel = document.getElementById("info");

            // activate info panel if checbox is checked in settings tab
            $("#info_settings").on('change', function() {
                if (this.checked) {
                    // remove "class "disabled" (show panel)
                    info_tab.removeClass(info_class);
                    info_popup = false;
                } else {
                    // add "class "disabled" (hide panel) this is default
                    info_tab.addClass(info_class);
                    info_popup = true;
                }
            })

            // LAYER INFO (POPUP OR PANEL DEPENDING ON SETTINGS)

            var popup = new ol.Overlay({
                element: document.getElementById('popup')
            });
            map.addOverlay(popup);
            
            // check if layer is a ol.layer.Group (return BOOLEAN)
            function isGroup(layer) {
                if (layer instanceof ol.layer.Group) {
                    return true;
                } else {
                    return false;
                }
            }
            
            // get layers in a group
            function getOLLayers(group) {
                let ol_layers = [];
                
                // get single layer
                function getOLLayer(layer, lyr_array) {
                    if (isGroup(layer)) {
                        let layers = layer.getLayers().getArray();
                        for (let i = 0; i < layers.length; ++i) {
                            getOLLayer(layers[i], lyr_array);
                        }
                    } else {
                        lyr_array.push(layer);
                        
                        return;
                    }
                }
                let layers = group.getLayers().getArray();
                for (let i = 0; i < layers.length; ++i) {
                    let lyr = getOLLayer(layers[i], ol_layers);
                }
                return ol_layers;
            }

            function getUrl(evt, lyr) {
                var coordinate = evt.coordinate;
                var url = '';
                var viewResolution = /** @type {number} */ (view.getResolution());
                if (lyr.get('type') != 'base') {
                    var visible = lyr.getVisible();
                    if (visible) {
                        url += lyr.get('source').getGetFeatureInfoUrl(evt.coordinate, viewResolution, 'EPSG:3857', {
                            'INFO_FORMAT': 'text/html'
                        });
                        return url;
                    }
                }
            }

            map.on('singleclick', function(evt) {

                // check wether to display info in popup or panel
                var layers = getOLLayers(map.getLayerGroup());
                for (var i = 0; i < layers.length; ++i) {
                    var layer = layers[i];
                    var text = getUrl(evt, layer);
                    if (text) {
                        $.get(text, function(data) {
                            if (data) {
                                if (data.length != 0) {
                                    // if true, displays the popup...
                                    if (info_popup) {
                                        // Add a click handler to the map to render the popup.
                                        var element = popup.getElement();
                                        var coordinate = evt.coordinate;
                                        $(element).popover('destroy');
                                        popup.setPosition(coordinate);
                                        $(element).popover({
                                            'placement': 'top',
                                            'animation': false,
                                            'html': true,
                                            'content': data
                                        });
                                        $(element).popover('show');
                                    // ... else, displays in panel
                                    } else {
                                        info_panel.innerHTML = (data);
                                        sidebar.open("info");
                                    }
                                } else {
                                    popup.setPosition(undefined);
                                    while (info_panel.hasChildNodes()) {
                                        info_panel.removeChild(info_panel.firstChild);
                                    }
                                }
                            }
                        })
                    }
                }
            })

            // SIDEBAR

            var sidebar = new ol.control.Sidebar({
                element: 'sidebar',
                position: 'left'
            });

            // OL-LAYERSWITCHER

            // Get out-of-the-map div element with the ID "layers" and renders layers to it.
            // NOTE: If the layers are changed outside of the layer switcher then you
            // will need to call ol.control.LayerSwitcher.renderPanel again to refesh
            // the layer tree. Style the tree via CSS.
            var toc = document.getElementById("layers");
            ol.control.LayerSwitcher.renderPanel(toc, map);

            // add sidebar to map

            map.addControl(sidebar);

            // LAYER VISIBILITY

            $('input[type=checkbox]').on('change', function() {
                var layer = {
                    layer1: layer1,
                    layer2: layer2,
                }[$(this).attr('id')];
                layer.setVisible(!layer.getVisible());
            });

            // BASEMAP RADIO BUTTONS
            $('input[type=radio]').on('change', function() {
                var basemaps = {
                    basemap1: basemap1,
                    basemap2: basemap2,
                };

                // turn off all basemaps...
                for (i in basemaps) {
                    basemaps[i].setVisible(false);
                }

                // then turn on only clicked basemap
                basemaps[$(this).attr('id')].setVisible(true);
            });

            // DEFINITION QUERY (GEOMETRIC FILTERS)
            // update WMS parameters (filter, see mapfile) based on user selected choice
            $('.query').on('change', function() {
                var filter = $(this).val();
                var params = wmsSource2.getParams();
                params.vitigni = filter;
                wmsSource2.updateParams(params);
            });

            // ZOOM
            // in the layers tab, zoom map to layer when zoom icon is clicked
            $('.fa-search').on('click', function() {
                var layer = {
                    layer1: layer1,
                    layer2: layer2,
                };
                // remove the "_zoom" suffix from "layer{n}_zoom" to get only the layer id
                var layer_id = $(this).attr('id').replace('_zoom', '');
                view.fit(layer[layer_id].getExtent(), {
                    duration: 1000
                });
            });
        }).catch(error => {
            console.log(error);
        })
    </script>
</body>

</html>
